{
  "metadata": {
    "id": "ppf-broker-complete",
    "name": "PPF Broker All Loan Types",
    "version": "1.0.0",
    "description": "Multi-flow form supporting DSCR and RTL loan types with dynamic borrower arrays",
    "formType": "MULTI_FLOW_FORM"
  },
  "flowSelection": {
    "step": "loan-type-selection",
    "field": "loanTypeName"
  },
  "steps": [
    {
      "id": "loan-type-selection",
      "name": "Choose Loan Program",
      "description": "Select the type of loan you want to apply for",
      "order": 1,
      "required": true,
      "fields": [
        {
          "id": "loanTypeName",
          "type": "radio",
          "name": "loanTypeName",
          "label": "Select Loan Type",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12 },
          "options": [
            {
              "value": "debt-service-coverage-ratio",
              "label": "DSCR (Debt Service Coverage Ratio)",
              "description": "Investment property loan based on rental income"
            },
            {
              "value": "residential-transition-loan",
              "label": "RTL (Residential Transition Loan)",
              "description": "Fix & flip, fix & hold, bridge loans"
            }
          ]
        }
      ]
    },
    {
      "id": "qualifying-info",
      "name": "Qualifying Information",
      "description": "Basic qualifying information for pricing",
      "order": 2,
      "required": true,
      "fields": [
        {
          "id": "loanPurpose",
          "type": "dropdown",
          "name": "loanPurpose",
          "label": "Loan Purpose",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "purchase", "label": "Purchase" },
            { "value": "refinance_rate_and_term", "label": "Refinance Rate-And-Term" },
            { "value": "refinance_cashout", "label": "Refinance Cashout" }
          ]
        },
        {
          "id": "propertyType",
          "type": "dropdown",
          "name": "propertyType",
          "label": "Property Type",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "single_family_residence", "label": "Single Family Residence" },
            { "value": "2_4_unit", "label": "2-4 Units" },
            { "value": "condominium", "label": "Condominium" },
            { "value": "townhome", "label": "Townhome" }
          ]
        },
        {
          "id": "propertyState",
          "type": "dropdown",
          "name": "propertyState",
          "label": "Property State",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "CA", "label": "California" },
            { "value": "NY", "label": "New York" },
            { "value": "TX", "label": "Texas" },
            { "value": "FL", "label": "Florida" }
          ]
        },
        {
          "id": "estimatedCreditScore",
          "type": "dropdown",
          "name": "estimatedCreditScore",
          "label": "Estimated Credit Score",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "760+", "label": "760+" },
            { "value": "740-759", "label": "740-759" },
            { "value": "720-739", "label": "720-739" },
            { "value": "700-719", "label": "700-719" },
            { "value": "680-699", "label": "680-699" }
          ]
        },
        {
          "id": "propertyValue",
          "type": "text",
          "name": "propertyValue",
          "label": "Property Value",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "placeholder": "500000"
        },
        {
          "id": "citizenship",
          "type": "dropdown",
          "name": "citizenship",
          "label": "Citizenship",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "us_citizen", "label": "U.S. Citizen" },
            { "value": "permanent_resident_alien", "label": "Permanent Resident Alien" },
            { "value": "non_permanent_resident_alien", "label": "Non-Permanent Resident Alien" }
          ]
        }
      ]
    },
    {
      "id": "dscr-details",
      "name": "DSCR Property Details",
      "description": "Rental property income and expense details",
      "order": 3,
      "required": true,
      "conditions": [
        { "===": [{"var": "loanTypeName"}, "debt-service-coverage-ratio"] }
      ],
      "fields": [
        {
          "id": "rentalUse",
          "type": "dropdown",
          "name": "rentalUse",
          "label": "Rental Use",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "long_term", "label": "Long Term" },
            { "value": "short_term", "label": "Short Term" }
          ]
        },
        {
          "id": "numberOfUnits",
          "type": "dropdown",
          "name": "numberOfUnits",
          "label": "Number of Units",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": 1, "label": "1" },
            { "value": 2, "label": "2" },
            { "value": 3, "label": "3" },
            { "value": 4, "label": "4" }
          ]
        },
        {
          "id": "monthlyPropertyTaxes",
          "type": "text",
          "name": "monthlyPropertyTaxes",
          "label": "Monthly Property Taxes",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount"
        },
        {
          "id": "monthlyInsurance",
          "type": "text",
          "name": "monthlyInsurance",
          "label": "Monthly Insurance",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount"
        },
        {
          "id": "unit1MonthlyRent",
          "type": "text",
          "name": "unit1MonthlyRent",
          "label": "Unit 1 Monthly Rent",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "conditions": [
            { ">=": [{"var": "numberOfUnits"}, 1] }
          ]
        },
        {
          "id": "unit2MonthlyRent",
          "type": "text",
          "name": "unit2MonthlyRent",
          "label": "Unit 2 Monthly Rent",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "conditions": [
            { ">=": [{"var": "numberOfUnits"}, 2] }
          ]
        }
      ]
    },
    {
      "id": "rtl-details",
      "name": "RTL Project Details",
      "description": "Rehab and construction project details",
      "order": 3,
      "required": true,
      "conditions": [
        { "===": [{"var": "loanTypeName"}, "residential-transition-loan"] }
      ],
      "fields": [
        {
          "id": "loanType",
          "type": "dropdown",
          "name": "loanType",
          "label": "Loan Type",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "fix_and_flip", "label": "Fix and Flip" },
            { "value": "fix_and_hold", "label": "Fix and Hold" },
            { "value": "bridge_loan", "label": "Bridge Loan" },
            { "value": "ground_up_construction", "label": "Ground Up Construction" }
          ]
        },
        {
          "id": "projectsCompleted",
          "type": "dropdown",
          "name": "projectsCompleted",
          "label": "Projects Completed in Past 36 Months",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "options": [
            { "value": "0", "label": "0" },
            { "value": "1", "label": "1" },
            { "value": "2", "label": "2" },
            { "value": "3", "label": "3" },
            { "value": "10+", "label": "10+" }
          ]
        },
        {
          "id": "rehabAmount",
          "type": "text",
          "name": "rehabAmount",
          "label": "Rehab Amount",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "conditions": [
            { "or": [
              { "===": [{"var": "loanType"}, "fix_and_flip"] },
              { "===": [{"var": "loanType"}, "fix_and_hold"] }
            ]}
          ]
        },
        {
          "id": "afterRepairValue",
          "type": "text",
          "name": "afterRepairValue",
          "label": "After Repair Value (ARV)",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "conditions": [
            { "or": [
              { "===": [{"var": "loanType"}, "fix_and_flip"] },
              { "===": [{"var": "loanType"}, "fix_and_hold"] },
              { "===": [{"var": "loanType"}, "ground_up_construction"] }
            ]}
          ]
        },
        {
          "id": "constructionBudget",
          "type": "text",
          "name": "constructionBudget",
          "label": "Construction Budget",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount",
          "conditions": [
            { "===": [{"var": "loanType"}, "ground_up_construction"] }
          ]
        },
        {
          "id": "availableLiquidity",
          "type": "text",
          "name": "availableLiquidity",
          "label": "Available Liquidity",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "formType": "amount"
        }
      ]
    },
    {
      "id": "borrower-selection",
      "name": "Application Type",
      "description": "Select application type and number of borrowers",
      "order": 4,
      "required": true,
      "fields": [
        {
          "id": "applicationType",
          "type": "radio",
          "name": "applicationType",
          "label": "Application Type",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12 },
          "options": [
            { "value": "individual", "label": "Individual" },
            { "value": "joint", "label": "Joint" }
          ]
        },
        {
          "id": "numberOfBorrowers",
          "type": "dropdown",
          "name": "numberOfBorrowers",
          "label": "Number of Borrowers",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "defaultValue": 2,
          "arrayController": "borrowers",
          "conditions": [
            { "===": [{"var": "applicationType"}, "joint"] }
          ],
          "options": [
            { "value": 2, "label": "2" },
            { "value": 3, "label": "3" },
            { "value": 4, "label": "4" }
          ]
        }
      ]
    }
  ],
  "arrayTemplates": {
    "borrowers": {
      "minCount": 1,
      "maxCount": 4,
      "defaultCount": 1,
      "countField": "numberOfBorrowers",
      "fieldTemplate": [
        {
          "id": "firstName",
          "type": "text",
          "label": "First Name",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "Please enter the name"
            },
            {
              "rule": "minLength",
              "value": 2,
              "message": "Name must be at least 2 characters"
            },
            {
              "rule": "maxLength",
              "value": 50,
              "message": "Name cannot exceed 50 characters"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "arrayIndex": true
        },
        {
          "id": "lastName",
          "type": "text",
          "label": "Last Name",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "Please enter the name"
            },
            {
              "rule": "minLength",
              "value": 2,
              "message": "Name must be at least 2 characters"
            },
            {
              "rule": "maxLength",
              "value": 50,
              "message": "Name cannot exceed 50 characters"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "arrayIndex": true
        },
        {
          "id": "email",
          "type": "email",
          "label": "Email Address",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "Please enter your email address"
            },
            {
              "rule": "email",
              "message": "Please enter a valid email address"
            }
          ],
          "grid": { "xs": 12 },
          "arrayIndex": true
        },
        {
          "id": "phone",
          "type": "phone",
          "label": "Phone Number",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "Please enter your phone number"
            },
            {
              "rule": "phoneUS",
              "message": "Please enter a valid US phone number"
            }
          ],
          "grid": { "xs": 12 },
          "arrayIndex": true
        },
        {
          "id": "ssn",
          "type": "password",
          "label": "SSN (9 digits)",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "arrayIndex": true
        },
        {
          "id": "dateOfBirth",
          "type": "date",
          "label": "Date of Birth",
          "required": true,
          "validation": [
            {
              "rule": "required",
              "message": "This field is required"
            }
          ],
          "grid": { "xs": 12, "sm": 6 },
          "arrayIndex": true
        }
      ]
    }
  },
  "navigation": {
    "type": "stepped",
    "allowBackward": true,
    "allowSkipping": false,
    "showProgress": true,
    "completionRequired": true
  },
  "transformations": {
    "inbound": {
      "loanTypeName": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanTypeName",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanTypeName",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "loanPurpose": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanInformation.loanPurpose",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanInformation.loanPurpose",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "propertyType": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanInformation.propertyType",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanInformation.propertyType",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "propertyState": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].propertyAddress.state",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.propertyAddress.state",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "propertyValue": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanInformation.propertyValue",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanInformation.propertyValue",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.estimatedPropertyValue",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "estimatedCreditScore": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanInformation.estimatedCreditScore",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanInformation.estimatedCreditScore",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "citizenship": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].loanInformation.citizenship",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.loanInformation.citizenship",
          "condition": "notEmpty"
        },
        { "default": "us_citizen" }
      ],

      "applicationType": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].applicationData.applicationType",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.applicationType",
          "condition": "notEmpty"
        },
        { "default": "individual" }
      ],

      "numberOfBorrowers": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].numberOfBorrowers",
          "condition": "notEmpty"
        },
        {
          "path": "additionalInfo.numberOfBorrowers",
          "condition": "notEmpty"
        },
        { "default": 1 }
      ],

      "rentalUse": [
        {
          "path": "additionalInfo.loanInformation.rentalUse",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "monthlyPropertyTaxes": [
        {
          "path": "additionalInfo.rentAndExpanses.monthlyPropertyTaxes",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "monthlyInsurance": [
        {
          "path": "additionalInfo.rentAndExpanses.monthlyInsurance",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "unit1MonthlyRent": [
        {
          "path": "additionalInfo.rentAndExpanses.unitRent[0].rent",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "unit2MonthlyRent": [
        {
          "path": "additionalInfo.rentAndExpanses.unitRent[1].rent",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "loanType": [
        {
          "path": "additionalInfo.loanType",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "projectsCompleted": [
        {
          "path": "additionalInfo.loanInformation.projectCompletedInPast36Month",
          "condition": "notEmpty"
        },
        { "default": "0" }
      ],

      "rehabAmount": [
        {
          "path": "additionalInfo.repairAndRehab.rehabAmount",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "afterRepairValue": [
        {
          "path": "additionalInfo.repairAndRehab.arv",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "constructionBudget": [
        {
          "path": "additionalInfo.repairAndRehab.constructionBudget",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "availableLiquidity": [
        {
          "path": "additionalInfo.repairAndRehab.availableLiquidity",
          "condition": "notEmpty"
        },
        { "default": "" }
      ],

      "borrowers[].firstName": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].borrowers",
          "type": "arrayField",
          "field": "firstName",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "additionalInfo.borrowers",
          "type": "arrayField",
          "field": "firstName",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "primaryBorrower.firstName",
          "transform": "singleToArray",
          "condition": "notEmpty"
        },
        { "default": [] }
      ],

      "borrowers[].lastName": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].borrowers",
          "type": "arrayField",
          "field": "lastName",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "additionalInfo.borrowers",
          "type": "arrayField",
          "field": "lastName",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "primaryBorrower.lastName",
          "transform": "singleToArray",
          "condition": "notEmpty"
        },
        { "default": [] }
      ],

      "borrowers[].email": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].borrowers",
          "type": "arrayField",
          "field": "email",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "additionalInfo.borrowers",
          "type": "arrayField",
          "field": "email",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "primaryBorrower.email",
          "transform": "singleToArray",
          "condition": "notEmpty"
        },
        { "default": [] }
      ],

      "borrowers[].phone": [
        {
          "path": "loanData.DEAL.EXTENSION.OTHER['saaf:DEAL_EXTENSION']['saaf:ApplicationData'].borrowers",
          "type": "arrayField",
          "field": "phone",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "additionalInfo.borrowers",
          "type": "arrayField",
          "field": "phone",
          "condition": "arrayNotEmpty"
        },
        {
          "path": "primaryBorrower.phone",
          "transform": "singleToArray",
          "condition": "notEmpty"
        },
        { "default": [] }
      ]
    },

    "outbound": {
      "loan.type": [
        { "path": "loanTypeName" }
      ],
      "loan.purpose": [
        { "path": "loanPurpose" }
      ],
      "property.type": [
        { "path": "propertyType" }
      ],
      "property.state": [
        { "path": "propertyState" }
      ],
      "property.value": [
        { "path": "propertyValue" }
      ],
      "borrowers[].personal.firstName": [
        {
          "path": "borrowers",
          "type": "arrayField",
          "field": "firstName"
        }
      ],
      "borrowers[].personal.lastName": [
        {
          "path": "borrowers",
          "type": "arrayField",
          "field": "lastName"
        }
      ],
      "borrowers[].personal.email": [
        {
          "path": "borrowers",
          "type": "arrayField",
          "field": "email"
        }
      ],
      "borrowers[].personal.phone": [
        {
          "path": "borrowers",
          "type": "arrayField",
          "field": "phone"
        }
      ],
      "application.type": [
        { "path": "applicationType" }
      ],
      "application.borrowerCount": [
        { "path": "numberOfBorrowers" }
      ]
    }
  }
}